<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Y3 | Control Tower - CONSOLE</title>
    <link rel="stylesheet" href="../../../depot/SDK/layui/v2.3.0/css/layui.css" media="all">
    <script src="../../../depot/SDK/jQuery/jquery.min.js" charset="utf-8"></script>
    <script src="../../../depot/SDK/jQuery/jquery.form.js" charset="utf-8"></script>
    <script src="../../../config/config.js" charset="utf-8"></script>
</head>
<style>
    body{
        width: 100%;
        height: 100%;
        background: rgba(0, 191, 179, .01);
    }
    .body-card{
        margin-bottom:15px;
        border-radius:2px;
        background-color: rgba(255,255,255,.05);
        box-shadow:0 1px 2px 0 rgba(0,0,0,.05);
        width: 100%;
        height: 100%;
    }
    .btn-group-style{
    }
    .layui-input, .layui-textarea, .layui-select,
    .layui-layedit, .layui-layedit-tool{border-color: #00bfb3;}
    .edit-form{
        margin: 15px 0 0 0;
        padding: 0;
        width: 80%;
    }
    #editForm .layui-form-item .layui-input-block input{
        max-width: 550px;
        min-width: 150px;
    }
    .layui-layer-page .layui-layer-content{
        position: relative;
        overflow: visible !important;
        height: 380px !important;
    }
    .layui-layer-page .layui-layer-btn{
        max-width: 650px;
    }
</style>
<script type="text/javascript">
    var default_request_url_ = _host+'sys/user';

    function staRemark(status) {
        if(status === 1){
            return 'ACTIVE';
        }
        return 'DEACTIVE';
    }

    /***
     * 初始化弹出框的内容
     * @param data
     */
    function initForm(data) {
        console.log(11,data)
        if(data!=null) {
            $("#editForm input[name='userid']").val(data.userid);
            $("#editForm input[name='usercode']").val(data.usercode);
            $("#editForm input[name='username']").val(data.username);
            $("#editForm input[name='agency']").val(data.agencyname);
            if (data.status === 1) {
                $("#editForm input[name='status']").attr("checked", true)
                $("#editForm input[name='status']").attr("value", 1);
            }
        }else{
            $("#editForm input[name='userid']").val('');
            $("#editForm input[name='usercode']").val('');
            $("#editForm input[name='username']").val('');
            $("#editForm input[name='userpwd']").val('');
            $("#editForm input[name='agency']").val('');
            $("#editForm input[name='manager']").val('');
            $("#editForm input[name='status']").attr("checked", false)
        }
        layui.form.render('checkbox')
    }

    function initSelectOption(){
        var request_url_aagency = _host+'sys/dic/agency?limit=-1&page=1';
        var msg  = "Operation failed！<br/>ERROR:an exception occurs when executing task!Please contact with your system administrator!";
        $('select[name="manager"]').empty();
        $.ajax({
            type: 'GET'
            ,url: request_url_aagency
            ,contentType: 'application/x-www-form-urlencoded '
            ,dataType: 'json'
            ,async: false
            ,success: function(data) {
                if(data.state && data.state==="1"){
                    msg = "Operation Acceptance!";
                    var hits = data.hits;
                    var options = "<option value=''></option>";
                    for(var i=0;i<hits.length;i++){
                        var item = hits[i]
                        options += "<option value='"+item.itemid+"'>"+item.name+"</option>";
                    }
                    $('select[name="manager"]').html(options)
                }else{
                    msg = "Operation failed！<br/>"+data.infos;
                }
                console.log(data)
            },
            error: function(data) {
            }
        })
    }

    $(function(){
        initSelectOption();
    })

//    setTimeout(function () {
//        $('select[name="manager"]').next().find('.layui-select-title input').click(function () {
//            alert(11212)
//            initSelectOption()
//        })
//    },1000)
</script>
<body layadmin-themealias="default">
<div class="body-card">
    <ins class="adsbygoogle" style="display:inline-block;width:970px;height:90px"
         data-ad-client="ca-pub-6111334333458862" data-ad-slot="3820120620"></ins>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 15px;">
        <legend>SYSTEM MANAGEMENT : USER</legend>
    </fieldset>

    <div id="body_table_user" class="" >
        <div class="btn-group-style">
            <div class="layui-btn-group btn-group-position">
                <button class="layui-btn layui-btn-sm" onclick="addRecord()" onmouseover="showTips(this,'add a new account')" onmouseout="hideTips()"><i class="layui-icon layui-icon-add-1"></i></button>
                <button class="layui-btn layui-btn-sm" onclick="del()" onmouseover="showTips(this,'delete a account is chosing')" onmouseout="hideTips()"><i class="layui-icon layui-icon-delete"></i></button>
            </div>
        </div>

        <table class="layui-table" lay-data="{height: 'full-240',page:true ,url:default_request_url_ ,id:'ds_user'}" lay-filter="userTableEvent">
            <thead>
            <tr>
                <th lay-data="{type:'checkbox'}"></th>
                <th lay-data="{field:'rn', width:60 ,sort:true}">No</th>
                <th lay-data="{field:'username', width:200, sort: true ,style:'cursor: pointer;'}">USERNAME</th>
                <th lay-data="{field:'agencyname' ,width:'220' ,style:'cursor: pointer;'}">AGENCY</th>
                <th lay-data="{field:'managername' ,width:'220' ,style:'cursor: pointer;'}">MANAGER</th>
                <th lay-data="{field:'usercode', width:200, sort: true ,style:'cursor: pointer;'}">USERCODE</th>
                <th lay-data="{field:'status' ,width:'220' ,style:'cursor: pointer;',templet: '<div>{{staRemark(d.status)}}</div>'}">STATUS</th>
                <th lay-data="{fixed: 'right', width:'200', align:'center', toolbar: '#barDemo'}"></th>
            </tr>
            </thead>
        </table>
    </div>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">EDIT</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">DEL</a>
    </script>
</div>

</body>

<form id="editForm" class="layui-form edit-form" hidden>
    <div class="layui-form-item" name="userid" hidden>
        <label class="layui-form-label">ID</label>
        <div class="layui-input-block">
            <input type="text" name="userid" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" name="usercode">
        <label class="layui-form-label">CODE</label>
        <div class="layui-input-block">
            <input type="text" name="usercode" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" name="username">
        <label class="layui-form-label">NAME</label>
        <div class="layui-input-block">
            <input type="text" name="username" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" name="userpwd">
        <label class="layui-form-label">PASSWORD</label>
        <div class="layui-input-block">
            <input type="password" name="userpwd" placeholder="********" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" name="agency">
        <label class="layui-form-label">AGENCY</label>
        <div class="layui-input-block">
            <input type="text" name="agency" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
    <div class="select-manager-style">
    <div class="layui-form-item" name="manager">
        <label class="layui-form-label">MANAGER</label>
        <div class="layui-input-inline">
            <select name="manager" lay-verify="required" lay-search="" lay-filter="managerEvent">
                <option value=""></option>
                <option value="11">11</option>
                <option value="22">22</option>
                <option value="33">33</option>
                <option value="44">44</option>
                <option value="55">55</option>
            </select>
        </div>
    </div>
    </div>
    <div class="layui-form-item" name="status">
        <label class="layui-form-label">STATUS</label>
        <div class="layui-input-block">
            <input type="checkbox" name="status" lay-skin="switch" lay-filter="statusEvent" lay-text="ACTIVE|DEACTIVE" value=0>
        </div>
    </div>
</form>

<script src="../../../depot/SDK/layui/v2.3.0/layui.js" charset="utf-8"></script>
<script type="text/javascript">

    var layer_tips_index;
    function showTips(e,info) {
        layer_tips_index = layer.tips(info, e, {tips:[3,'#00C5B9']});
    }
    function hideTips() {
        layer.close(layer_tips_index)
    }
    // 全局设置弹出层的垂直相对位置
    layui.use('layer', function(){
        layer.config({offset: '18%'});
    });

    /***
     * 弹出编辑框
     * @param callback
     */
    function showEditLayer() {
        layer.open({
            type: 1
            ,title: '<B>EDITER</B>'
            ,area: ['550px', '500px']
            ,shade: 0.5
            ,maxmin: true
            ,content: $('#editForm')
            ,btn: ['COMMIT', 'CANCEL'] //只是为了演示
            ,yes: function(index,layero){
                var inputForm = $(layero).find("#editForm")
                inputForm.ajaxSubmit({
                     url: default_request_url_
                    ,type:'post'
                    ,dataType:'json'
                    ,contentType: 'application/x-www-form-urlencoded'
                    ,async: false
                    ,success:function(result){
                        if(result.state && result.state==="1"){
                            layer.alert(
                                "Operation Acceptance!<br />Notice: Initial password is '1qaz2wsx', you can change it yourself in [USER CENTER]"
                                ,{title:'System Info' ,icon: 1 ,btn:['OK'] ,zIndex:layer.zIndex+1,yes:function () {layer.closeAll();}}
                            )
                        }else{
                            layer.alert(
                                "ERROR:an exception occurs when executing task!Please contact with your system administrator!"
                                ,{title:'System Info' ,icon: 2 ,btn:['OK'] ,zIndex:layer.zIndex+1,yes:function () {layer.closeAll();}}
                            )
                        }
                    }
                });
            }
            ,btn2: function(){
                layer.closeAll();
            }
//            ,zIndex: layer.zIndex //重点1
//            ,success: function(layero){
//                layer.setTop(layero); //重点2
//            }
        });
    }

    /***
     * 添加记录
     */
    function addRecord() {
        initForm(null);
        showEditLayer()
        $("div[name='userpwd']").hide()
    }
    function deleteRecord(data,callback) {
        var msg  = "Operation failed！<br/>ERROR:an exception occurs when executing task!Please contact with your system administrator!";
        var status = 0;
        console.log(data)
        $.ajax({
            type: 'DELETE'
            ,url: default_request_url_ +"/"+ data.userid
            ,contentType: 'application/x-www-form-urlencoded '
            ,dataType: 'json'
            ,async: false
            ,success: function(data) {
                if(data){
                    var state = data.state;
                    if(state && state==="1"){
                        msg = "Operation Acceptance!";
                        status = 1;
                    }else{
                        msg = "Operation failed！<br/>"+data.infos;
                    }
                }
                callback(msg,status);
            },
            error: function(data) {
                callback(msg,status);
            }
        })
    }


    // table 框架的主要事件
    layui.use('table', function () {
        var table = layui.table;

        //监听表格复选框选择
        table.on('checkbox(userTableEvent)', function (obj) {
            console.log(obj)
        });

        //监听工具条
        table.on('tool(userTableEvent)', function (obj) {
            var item = obj.data;
            var select_field;
            var select_field_val;
            console.log(11,item)

            // edit button event
            if (obj.event === 'edit') {
                initForm(item);
                showEditLayer()
                $("div[name='userpwd']").show()
            }
            // delete button event
            else if (obj.event === 'del') {
                deleteRecord(item,function(msg,status){
                    console.log(55,status)
                    layer.alert(msg, function (index) {
                        if(status===1) {
                            obj.del();
                            table.render();
                        }
                        layer.close(index);
                        })
                    }
                );
            }
        });

    });


    layui.use('form', function () {
        var form = layui.form;

        form.on('select(managerEvent)', function (data) {
            console.log(62,data.value); //得到被选中的值
        });

        form.on('switch(statusEvent)', function(data){
            if(data.elem.checked){
                data.elem.value = 1;
            }else{
                data.elem.value = 0;
            }
            form.render()
        });
    })

</script>


</html>