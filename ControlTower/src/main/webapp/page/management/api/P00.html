<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Y3 | Control Tower - CONSOLE</title>
    <link rel="stylesheet" href="../../../depot/SDK/layui/v2.3.0/css/layui.css" media="all">
    <script src="../../../depot/SDK/jQuery/jquery.min.js" charset="utf-8"></script>
    <script src="../../../config/config.js" charset="utf-8"></script>
</head>
<style>
    body{
        width: 100%;
        height: 100%;
        background: rgba(0, 191, 179, .01);
    }
    .body-card{
        margin-bottom:15px;
        border-radius:2px;
        background-color: rgba(255,255,255,.05);
        box-shadow:0 1px 2px 0 rgba(0,0,0,.05);
        width: 100%;
        height: 100%;
        /*padding: 1px;*/
    }
    .btn-group-style{
    }
    .from-style{
        padding-left: 5px;
        padding-right: 5px;
        margin-top: 10px;
    }
    .layui-form-pane .layui-inline{
        margin-right: -4px;
    }
    .input-method{
        min-width: 40px;
        width: 80px;
    }
    .input-method .layui-form-select dl dd.layui-this { background-color: rgba(103, 43, 140, 1) }
    .input-method .layui-form-select dl { border-color: rgba(103, 43, 140, 1) }
    .input-urlpath{
        min-width: 100px;
        width: 600px;
    }
    .layui-input, .layui-textarea, .layui-select,
    .layui-form-pane .layui-btn-primary,
    .layui-form-pane .layui-form-item[pane],
    .layui-layedit, .layui-layedit-tool{border-color: #00bfb3;}
    .layui-btn-primary{
        background: #00bfb3;
        color: #fff !important;
    }
    #ds_api_param .from-style .layui-inline .layui-select:hover, .layui-input:hover, .layui-textarea:hover{border:2px solid #00bfb3 !important;}
    #ds_api_param .from-style .layui-inline .layui-select:focus, .layui-input:focus, .layui-textarea:focus{border:2px solid #00bfb3 !important;}
    #ds_api_param .from-style .layui-btn-primary:hover{border:2px solid #009387; color: rgba(103, 43, 140, 1)}
    #ds_api_param .from-style .layui-btn-primary:focus{border:2px solid #00bfb3; color: rgba(103, 43, 140, 1)}
    .input-params-style{width: 80px}
    .params-table{
        margin-top: 2px;
        min-height: 80px;
        width: 100%;
        border-top: 1px solid #e2e2e2;
    }
    .params-label {
        min-width: 200px;
        width: 430px !important;
    }
    .input-params {
        margin-left: 0px !important;
    }
    .input-params input{
        min-width: 200px;
        width: 430px !important;
    }
</style>
<script type="text/javascript">
    var tableRequestURLinAction = _host+'mng/api';
    function setTableRequestURL() {
        if(tableOnShow === "ds_api"){
            tableRequestURLinAction = _host+'mng/api';
        }
    }
</script>
<body layadmin-themealias="default">
<div class="body-card">
    <ins class="adsbygoogle" style="display:inline-block;width:970px;height:90px"
         data-ad-client="ca-pub-6111334333458862" data-ad-slot="3820120620"></ins>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 15px;">
        <legend>ARRS: HPB Tracking</legend>
    </fieldset>

    <div id="body_table_api" class="" >
        <div class="btn-group-style">
            <div class="layui-btn-group btn-group-position">
                <button class="layui-btn layui-btn-sm" onclick="addRow()" onmouseover="showTips(this,'add a new param')" onmouseout="hideTips()"><i class="layui-icon layui-icon-add-1"></i></button>
                <button class="layui-btn layui-btn-sm" onclick="save()" onmouseover="showTips(this,'save modifications')" onmouseout="hideTips()"><i class="layui-icon layui-icon-ok"></i></button>
                <button class="layui-btn layui-btn-sm" onclick="del()" onmouseover="showTips(this,'delete a param that is chosing')" onmouseout="hideTips()"><i class="layui-icon layui-icon-delete"></i></button>
            </div>
        </div>

        <table class="layui-table" lay-data="{height: 'full-350',page:true, url:tableRequestURLinAction ,id:'ds_api'}" lay-filter="demoEvent">
            <thead>
            <tr>
                <th lay-data="{type:'checkbox'}"></th>
                <th lay-data="{field:'code', width:80, sort: true ,style:'cursor: pointer;' ,event:'set_code'}">CODE</th>
                <th lay-data="{field:'discription' ,width:'50%' ,style:'cursor: pointer;' ,edit:'text' ,event:'set_discription'}">DISCRIPTION</th>
                <th lay-data="{fixed: 'right', width:'200', align:'center', toolbar: '#barDemo'}"></th>
            </tr>
            </thead>
        </table>
    </div>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="detail">VIEW</a>
        <!--<a class="layui-btn layui-btn-xs" lay-event="edit">EDIT</a>-->
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">DEL</a>
    </script>

    <!-- param div -->
    <div class="" id="ds_api_param" hidden>
        <div class="btn-group-style">
            <div class="layui-btn-group btn-group-position">
                <button class="layui-btn layui-btn-sm" onclick="back2Main()" onmouseover="showTips(this,'back to the main list')" onmouseout="hideTips()"><i class="layui-icon layui-icon-left"></i></button>
                <button class="layui-btn layui-btn-sm" onclick="addRow()" onmouseover="showTips(this,'add a new param')" onmouseout="hideTips()"><i class="layui-icon layui-icon-add-1"></i></button>
                <button class="layui-btn layui-btn-sm" onclick="save()" onmouseover="showTips(this,'save modifications')" onmouseout="hideTips()"><i class="layui-icon layui-icon-ok"></i></button>
                <button class="layui-btn layui-btn-sm" onclick="del()" onmouseover="showTips(this,'delete a param that is chosing')" onmouseout="hideTips()"><i class="layui-icon layui-icon-delete"></i></button>
            </div>
        </div>
        <div class="from-style layui-form layui-form-pane">
            <div class="layui-inline">
                <div class="input-method layui-input-inline">
                    <select name="interest" lay-filter="req_method">
                        <option value="GET">GET</option>
                        <option value="POST" selected="">POST</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <div class="input-urlpath layui-input-inline">
                    <input type="text" name="urlpath" lay-verify="urlpath" autocomplete="off" placeholder="Enter request URL" class="layui-input">
                </div>
            </div>
            <button class="input-params-style layui-btn layui-btn-primary">Send</button>
            <div class="params-table layui-inline">
                <table class="layui-table" lay-data="{id:'ds_api_params' }" lay-filter="ds_api_params">
                    <thead>
                    <tr>
                        <th lay-data="{field:'' ,width:50}"></th>
                        <th lay-data="{field:'key', width:'300', sort: true ,edit:'text' ,event:'set_key'}">KEY</th>
                        <th lay-data="{field:'value' ,width:'300' ,edit:'text' ,event:'set_val'}">VALUE</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>

    </div>

</div>

</body>

<script src="../../../depot/SDK/layui/v2.3.0/layui.js" charset="utf-8"></script>
<script type="text/javascript">

    var tableOnShow = "ds_api";

    function convertDatetime(datetime) {
        var date = new Date(parseInt(datetime.slice(6)));
        return date.getFullYear() + '-' + (date.getUTCMonth() + 1) + '-' + date.getUTCDate() + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()
    }
    function back2Main() {
        $('#body_table_api').show();
        $('#ds_api_param').hide();
        tableOnShow = "ds_api";
    }
    var layer_index;
    function showTips(e,info) {
        layer_index = layer.tips(info, e, {tips:[3,'#00C5B9']});
    }
    function hideTips() {
        layer.close(layer.index)
    }
    function saveApiMain(data,obj) {
        if(data != obj){ data.uuid = obj.uuid; }
        var url = _host+"mng/api";
        $.ajax({
            type: 'POST'
            ,url: url
            ,data: {data:JSON.stringify(data)}
            ,contentType: 'application/x-www-form-urlencoded '
            ,dataType: 'json'
            ,async: false
            ,success: function(data) {
                if(data){
                    var state = data.state;
                    if(state && state==="1"){
                        layui.layer.open({title: 'System Info',content: 'update succesed！'});
                        return true;
                    }else{
                        layui.layer.open({title: 'System Info',content: 'update failed！<br/>'+data.infos});
                    }

                }else{
                    layui.layer.open({title: 'System Info',content: 'update failed！<br/>ERROR:an exception occurs when executing task!Please contact with your system administrator!'});
                }
                return false;
            },
            error: function(data) {
                layui.layer.open({title: 'System Info',content: 'update failed！<br/>ERROR:an exception occurs when executing task!Please contact with your system administrator!'});
            }
        })

        return false;
    }

    function deleteRow(data,callback) {
        var msg  = "delete failed！<br/>ERROR:an exception occurs when executing task!Please contact with your system administrator!";
        $.ajax({
            type: 'DELETE'
            ,url: tableRequestURLinAction +"/"+ data.uuid
            ,contentType: 'application/x-www-form-urlencoded '
            ,dataType: 'json'
            ,async: false
            ,success: function(data) {
                if(data){
                    var state = data.state;
                    if(state && state==="1"){
                        msg = "delete succesed！";
                    }else{
                        msg = "delete failed！<br/>"+data.infos;
                    }

                }
                callback(msg);
            },
            error: function(data) {
                callback(msg);
            }
        })
    }

    // 全局设置弹出层的垂直相对位置
    layui.use('layer', function(){
        layer.config({offset: '20%'});
    });

    // table 框架的主要事件
    layui.use('table', function () {
        var table = layui.table;
        var select_api;

        //监听表格复选框选择
        table.on('checkbox(demoEvent)', function (obj) {
            console.log(obj)
        });

        table.on('edit(ds_api)', function (obj) {
            if(isModify){
            } if(selectCellVal != obj.value ){
                isModify = true;
            }
        });

        //监听工具条
        table.on('tool(demoEvent)', function (obj) {
            var item = obj.data;
            var select_field;
            var select_field_val;
            var isEmptyUUID = true ,isEmptyDiscrp = true;

            if(!item || item.uuid==="" || item.uuid===null){
            }else{
                isEmptyUUID = false;
            }
            if(!item || item.discription==="" || item.discription===null){
            }else{
                isEmptyDiscrp = false;
            }

            for(k in item){
                var val_ = item[k];
                if( obj.event === ('set_'+k) ) {
                    select_field = k;
                    select_field_val = val_;
                    if (!isEmptyUUID) { // 新增的row，不用弹出框进行编辑
                        layer.prompt({
                            formType: 2
                            , title: 'EDIT[' + k + ']'
                            , value: val_
                            //,offset: '20%'
                            , btn: ['OK', 'Cancel']
                            }
                            , function (value, index) {
                            layer.close(index);
                            var d = {};
                            eval("d." + select_field + " = value")
                            saveApiMain(d, item)
                            //同步更新表格和缓存对应的值
                            eval("obj.update({ " + select_field + ":value })")
                        });
                    }
                }
            }

            // view button event
            if (obj.event === 'detail') {
                if(isEmptyDiscrp){ // discription 需要有值
                    layer.msg('Need a discription!')
                    return;
                }
                if(isEmptyUUID){
                    if(!saveApiMain(item,item))
                        return;
                }
                select_api = item;
                $('#body_table_api').hide();
                $('#ds_api_param').show();
                tableOnShow = "ds_api_params";

                // 参数主属性
                var host = select_api.host;
                if(!host.endsWith('/')){
                    host = host+'/'
                }
                $("input[name='urlpath']").attr("value",host+select_api.urlpath)

                var req_method_ = select_api.method.toUpperCase();
                $("select[name='interest']").find("option[value="+req_method_+"]").attr("selected",true);
                layui.form.render('select'); // render the FORM to set the default
                //重载 ds_api_params 的数据
                table.reload('ds_api_params', {
                    url: _host+'mng/api/params/'+select_api.uuid
                })

            }
            // delete button event
            else if (obj.event === 'del') {
                deleteRow(item,function(msg){
                    layer.confirm(msg, function (index) {
                            obj.del();
                            layer.close(index);
                        })
                    }
                );
            }
//            else if (obj.event === 'edit') {
//                layer.alert('编辑行：<br>' + JSON.stringify(data))
//            }
        });

        /* ********** 参数框的编辑 ********** */
        var selectCellVal;
        var isModify = false;

        table.on('tool(ds_api_params)', function (obj) {
            var data = obj.data;
            for(var k_ in data){
                if( obj.event == ('set_'+k_) ){
                    eval("selectCellVal = data."+k_)
                }
            }
        })

        table.on('edit(ds_api_params)', function (obj) {
            if(isModify){
            } if(selectCellVal != obj.value ){
                isModify = true;
            }
        });

    });

    function addRow(table) {

        var tmp = [] ,obj = {};
        var tableDataInAction = layui.table.cache[tableOnShow];
        console.log(33,layui.table)
        for(k in tableDataInAction[0]){
            eval(" obj."+k+" = null ")
        }
        tmp.push(obj)
        tmp = tmp.concat(tableDataInAction)

        console.log(33,tableRequestURLinAction)
        layui.table.reload(tableOnShow,{data: tmp, url:null});

    }


</script>


</html>